<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Manuscript | IJMR</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
    <div class="brand"><h1>IJMR</h1><p>Submission Portal</p></div>
</header>

<nav>
    <a href="index.html">Home</a>
    <a href="submit.html" class="active">Submit</a>
    <a href="login.html">Login</a>
</nav>

<div class="section reveal">
    <div class="glass-card form-container">
        <h2 class="text-center" style="color: var(--primary);">Submit Manuscript</h2>
        <p class="text-center" style="margin-bottom: 30px; color: var(--text-muted);">
            Complete the details below to initiate peer review.
        </p>
        
        <form id="submitForm">
            
            <label>Author Full Name <span style="color: #ff4444;">*</span></label>
            <input type="text" id="authorName" placeholder="e.g. John Doe" required>

            <label>Email Address <span style="color: #ff4444;">*</span></label>
            <input type="email" id="authorEmail" placeholder="john@university.edu" required>

            <label>Research Domain <span style="color: #ff4444;">*</span></label>
            <select id="paperDomain" required>
                <option value="" disabled selected>Select a Domain</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Engineering">Engineering</option>
                <option value="Medical Sciences">Medical Sciences</option>
                <option value="Management">Management</option>
            </select>

            <label>Paper Title <span style="color: #ff4444;">*</span></label>
            <input type="text" id="paperTitle" placeholder="Enter the full title" required>

            <label>Abstract <span style="color: #ff4444;">*</span></label>
            <textarea id="paperAbstract" rows="5" placeholder="Paste your abstract here..." required></textarea>

            <label>Upload File (PDF/Docx) <span style="color: #ff4444;">*</span></label>
            <div style="border: 2px dashed var(--glass-border); padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: var(--text-muted); margin-bottom: 10px;">Drag & Drop or Click to Upload</p>
                <input type="file" style="display: none;" id="file" required accept=".pdf,.doc,.docx">
                <button type="button" class="btn btn-outline" onclick="document.getElementById('file').click()">Select File</button>
                <p id="filename" style="margin-top: 10px; font-size: 0.8rem; color: var(--primary);"></p>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-paper-plane" style="margin-right: 8px;"></i> Submit Paper
            </button>

            <p id="statusMsg" style="text-align: center; margin-top: 15px; font-size: 0.9rem; display: none;"></p>
        </form>
    </div>
</div>

<script src="js/app.js"></script>

<!-- SUPABASE LOGIC -->
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // --- YOUR SUPABASE KEYS (DO NOT CHANGE) ---
    const SUPABASE_URL = 'https://xspbtzxgawwynybzfznv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcGJ0enhnYXd3eW55Ynpmem52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzA0MzcsImV4cCI6MjA4MDc0NjQzN30.0Htpq1U2B8EhpgeyEwRr6FByEEUF58h_PTo7twYQN7k';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // 1. File Selection UI Logic
    document.getElementById('file').addEventListener('change', function(){
        document.getElementById('filename').innerText = this.files[0] ? this.files[0].name : '';
    });

    const form = document.getElementById('submitForm');
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // 2. Check Login Status
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            alert("Please login first to submit a paper.");
            window.location.href = "login.html";
            return;
        }

        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('statusMsg');
        const fileInput = document.getElementById('file');
        const file = fileInput.files[0];

        if (!file) return alert("Please select a file");

        // 3. UI Loading State
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Uploading...';
        btn.disabled = true;
        msg.style.display = 'none';

        try {
            // 4. Upload File to Storage
            const fileName = `${user.id}/${Date.now()}_${file.name.replace(/\s+/g, '_')}`; // Sanitize filename
            
            const { data: fileData, error: uploadError } = await supabase.storage
                .from('submissions')
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (uploadError) throw new Error(`Upload Failed: ${uploadError.message}`);

            // 5. Get Public URL
            const { data: { publicUrl } } = supabase.storage
                .from('submissions')
                .getPublicUrl(fileName);

            // 6. Save Data to Database
            const { error: dbError } = await supabase
                .from('submissions')
                .insert([{
                    user_id: user.id,
                    author_name: document.getElementById('authorName').value,
                    email: document.getElementById('authorEmail').value,
                    domain: document.getElementById('paperDomain').value,
                    title: document.getElementById('paperTitle').value,
                    abstract: document.getElementById('paperAbstract').value,
                    file_url: publicUrl,
                    status: 'Under Review'
                }]);

            if (dbError) throw new Error(`Database Error: ${dbError.message}`);

            // 7. Success Message
            btn.innerHTML = '<i class="fas fa-check"></i> Submitted!';
            btn.style.background = '#10b981';
            msg.style.display = 'block';
            msg.style.color = '#10b981';
            msg.innerHTML = "Success! Manuscript uploaded.";
            
            setTimeout(() => window.location.href = 'index.html', 2000);

        } catch (error) {
            console.error("Full Error:", error);
            msg.style.display = 'block';
            msg.style.color = '#ff4444';
            msg.innerText = error.message; // Shows exact error on screen
            btn.innerHTML = 'Try Again';
            btn.disabled = false;
        }
    });
</script>
</body>
</html>