<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings | IJMR</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
    <div class="brand"><h1>IJMR</h1><p>Researcher Profile</p></div>
</header>

<nav>
    <a href="index.html">Home</a>
    <a href="submit.html">Submit</a>
    <!-- Auth.js will inject the profile icon here -->
</nav>

<div class="section reveal">
    <div class="glass-card" style="max-width: 500px; margin: 0 auto; padding: 2.5rem;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--text); margin:0;">Edit Profile</h2>
            <button id="logoutBtn" class="btn btn-outline" style="padding: 5px 15px; font-size: 0.8rem; border-color: #ff4444; color: #ff4444;">Logout</button>
        </div>

        <div style="text-align: center; margin-bottom: 25px;">
            <div style="position: relative; width: 100px; height: 100px; margin: 0 auto;">
                <img id="avatarPreview" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
                <label for="fileInput" style="
                    position: absolute; bottom: 0; right: 0; 
                    background: var(--primary); color: #000; 
                    width: 30px; height: 30px; border-radius: 50%; 
                    display: flex; align-items: center; justify-content: center; 
                    cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                ">
                    <i class="fas fa-camera" style="font-size: 0.8rem;"></i>
                </label>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 10px;">Max size: 500KB</p>
        </div>

        <form id="profileForm">
            <label>Full Name</label>
            <input type="text" id="fullName" placeholder="Your Name">

            <label>Email (Read Only)</label>
            <input type="text" id="emailDisplay" disabled style="opacity: 0.6; cursor: not-allowed;">

            <label>Role</label>
            <input type="text" id="roleDisplay" disabled style="opacity: 0.6; cursor: not-allowed;">

            <button type="submit" id="saveBtn" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                Save Changes
            </button>
            <p id="msgBox" style="text-align: center; margin-top: 15px; display: none; font-size: 0.9rem;"></p>
        </form>
    </div>
</div>

<script src="js/app.js"></script>

<script type="module">
    import Auth from './js/auth.js';

    const avatarPreview = document.getElementById('avatarPreview');
    const fileInput = document.getElementById('fileInput');
    const nameInput = document.getElementById('fullName');
    const emailInput = document.getElementById('emailDisplay');
    const roleInput = document.getElementById('roleDisplay');
    const saveBtn = document.getElementById('saveBtn');
    const msgBox = document.getElementById('msgBox');
    let selectedFile = null;

    // Load Data when Auth is ready
    // We poll briefly or wait for Auth to populate
    const initProfile = setInterval(() => {
        if (Auth.user && Auth.userProfile) {
            clearInterval(initProfile);
            renderProfile(Auth.user, Auth.userProfile);
        }
    }, 500);

    function renderProfile(user, profile) {
        nameInput.value = profile.full_name || '';
        emailInput.value = user.email;
        roleInput.value = profile.role || 'User';
        
        const defaultAvatar = `https://ui-avatars.com/api/?name=${profile.full_name || 'User'}&background=00d2ff&color=fff`;
        avatarPreview.src = profile.avatar_url || defaultAvatar;
    }

    // Handle File Selection & Preview
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // 500KB Check on selection
        if (file.size > 500 * 1024) {
            alert("File is too large! Please select an image under 500KB.");
            this.value = ''; // Clear input
            return;
        }

        selectedFile = file;
        avatarPreview.src = URL.createObjectURL(file); // Instant preview
    });

    // Handle Save
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;
        msgBox.style.display = 'none';

        try {
            let photoURL = Auth.userProfile.avatar_url;

            // 1. Upload new avatar if selected
            if (selectedFile) {
                photoURL = await Auth.uploadAvatar(selectedFile);
            }

            // 2. Update Profile Data
            await Auth.updateProfileData(nameInput.value, photoURL);

            // Success UI
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Changes Saved';
            saveBtn.style.background = '#10b981';
            msgBox.style.display = 'block';
            msgBox.style.color = '#10b981';
            msgBox.innerText = "Profile updated successfully!";

            setTimeout(() => {
                saveBtn.innerHTML = 'Save Changes';
                saveBtn.style.background = '';
                saveBtn.disabled = false;
            }, 2000);

        } catch (error) {
            console.error(error);
            msgBox.style.display = 'block';
            msgBox.style.color = '#ff4444';
            msgBox.innerText = error.message;
            saveBtn.innerHTML = 'Save Changes';
            saveBtn.disabled = false;
        }
    });

    // Logout Button
    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm("Are you sure you want to logout?")) Auth.logout();
    });
</script>
</body>
</html>