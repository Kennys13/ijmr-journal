<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile | IJMR</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        label { color: var(--primary); font-size: 0.9rem; margin-top: 10px; display: block;}
        input, textarea { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: white; padding: 8px; width: 100%; border-radius: 4px;}
        input:disabled { opacity: 0.5; cursor: not-allowed; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>

<header>
    <div class="brand"><h1>IJMR</h1><p>Researcher Dashboard</p></div>
</header>

<nav>
    <a href="index.html">Home</a>
    <!-- Auth.js injects profile/logout here -->
</nav>

<div class="section reveal">
    <div class="glass-card" style="max-width: 700px; margin: 0 auto;">
        
        <div style="display:flex; align-items:center; gap:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px; margin-bottom:20px;">
            <div style="position:relative;">
                <img id="avatarPreview" src="" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid var(--primary);">
                <label for="fileInput" style="position:absolute; bottom:0; right:0; background:var(--primary); color:black; width:25px; height:25px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                    <i class="fas fa-camera" style="font-size:12px;"></i>
                </label>
                <input type="file" id="fileInput" style="display:none;" accept="image/*">
            </div>
            <div>
                <h2 id="nameDisplay" style="margin:0; color:white;">Loading...</h2>
                <span id="roleDisplay" style="background:rgba(0, 210, 255, 0.1); color:var(--primary); padding:2px 8px; border-radius:10px; font-size:0.8rem;">...</span>
            </div>
            <button id="logoutBtn" class="btn btn-outline" style="margin-left:auto; border-color:#ff4444; color:#ff4444;">Logout</button>
        </div>

        <form id="profileForm">
            <div class="grid-2">
                <div><label>Full Name</label><input type="text" id="full_name"></div>
                <div><label>Email (Locked)</label><input type="text" id="email" disabled></div>
                <div><label>Mobile</label><input type="text" id="mobile"></div>
                <div><label>Country</label><input type="text" id="country"></div>
            </div>

            <label>Affiliation / Institution</label>
            <input type="text" id="affiliation">

            <div class="grid-2">
                <div><label>Department</label><input type="text" id="department"></div>
                <div><label>Designation</label><input type="text" id="designation"></div>
            </div>

            <label>ORCID iD</label>
            <input type="text" id="orcid">

            <label>Biography</label>
            <textarea id="bio" rows="3"></textarea>

            <button type="submit" id="saveBtn" class="btn btn-primary" style="width:100%; margin-top:20px;">Save Changes</button>
            <p id="msg" style="text-align:center; margin-top:10px;"></p>
        </form>
    </div>
</div>

<script src="js/app.js"></script>
<script type="module">
    import Auth from './js/auth.js';

    const fields = ['full_name', 'mobile', 'country', 'affiliation', 'department', 'designation', 'orcid', 'bio'];
    
    // Load Data
    const init = setInterval(() => {
        if (Auth.user && Auth.userProfile) {
            clearInterval(init);
            loadData(Auth.user, Auth.userProfile);
        }
    }, 500);

    function loadData(user, profile) {
        document.getElementById('email').value = user.email;
        document.getElementById('nameDisplay').innerText = profile.full_name;
        document.getElementById('roleDisplay').innerText = profile.role;
        document.getElementById('avatarPreview').src = profile.avatar_url;

        fields.forEach(f => {
            if(document.getElementById(f)) document.getElementById(f).value = profile[f] || '';
        });
    }

    // Handle File Upload
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        try {
            document.getElementById('msg').innerText = "Uploading image...";
            const newUrl = await Auth.uploadAvatar(file);
            document.getElementById('avatarPreview').src = newUrl;
            await Auth.updateProfileData(Auth.user.id, { avatar_url: newUrl });
            document.getElementById('msg').innerText = "Avatar updated!";
        } catch(err) {
            alert(err.message);
        }
    });

    // Handle Form Save
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerText = "Saving...";

        const updates = {};
        fields.forEach(f => updates[f] = document.getElementById(f).value);

        try {
            await Auth.updateProfileData(Auth.user.id, updates);
            btn.innerText = "Saved!";
            btn.style.background = "#10b981";
            setTimeout(() => { btn.disabled = false; btn.innerText = "Save Changes"; btn.style.background = ""; }, 2000);
        } catch(err) {
            alert(err.message);
            btn.disabled = false;
        }
    });

    document.getElementById('logoutBtn').onclick = () => Auth.logout();
</script>
</body>
</html>