/**
 * IJMR FIREBASE AUTHENTICATION
 * Connects to Firebase Auth for secure, persistent login.
 */

// Import Firebase SDKs from CDN (No installation needed)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
    getAuth, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

class AuthService {
    constructor() {
        // --- 1. PASTE YOUR FIREBASE CONFIG HERE ---
        // (Get this from Project Settings > General > Your Apps in Firebase Console)
        this.firebaseConfig = {
            apiKey: "AIzaSy...", 
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456...",
            appId: "1:123456..."
        };
        // ------------------------------------------

        // Initialize Firebase
        this.app = initializeApp(this.firebaseConfig);
        this.auth = getAuth(this.app);
        this.user = null;

        // Start listening for auth changes immediately
        this.monitorAuthState();
    }

    /**
     * Real-time listener: Runs whenever user logs in or out
     * Persists session even if page refreshes.
     */
    monitorAuthState() {
        onAuthStateChanged(this.auth, (user) => {
            this.user = user;
            if (user) {
                console.log("User is logged in:", user.email);
            } else {
                console.log("User is logged out");
            }
            this.updateUI(user);
        });
    }

    /**
     * Login Function
     * @param {string} email 
     * @param {string} password 
     * @param {string} role - Selected from dropdown (Stored locally for UI only)
     */
    async login(email, password, role) {
        try {
            // 1. Authenticate with Firebase
            const userCredential = await signInWithEmailAndPassword(this.auth, email, password);
            
            // 2. Store the role (Since Firebase Auth doesn't store roles by default without DB)
            localStorage.setItem('ijmr_user_role', role);

            return userCredential.user;
        } catch (error) {
            console.error("Login Error:", error.code, error.message);
            
            // Convert Firebase error codes to friendly messages
            let message = "Login failed. Please try again.";
            if (error.code === 'auth/invalid-credential') message = "Incorrect email or password.";
            if (error.code === 'auth/user-not-found') message = "No account found with this email.";
            if (error.code === 'auth/wrong-password') message = "Incorrect password.";
            if (error.code === 'auth/too-many-requests') message = "Too many failed attempts. Try later.";
            
            throw new Error(message);
        }
    }

    /**
     * Logout Function
     */
    async logout() {
        try {
            await signOut(this.auth);
            localStorage.removeItem('ijmr_user_role'); // Clear role
            window.location.href = 'login.html'; // Redirect to login
        } catch (error) {
            console.error("Logout Error:", error);
        }
    }

    /**
     * Updates the Navbar based on login state
     */
    updateUI(user) {
        const loginLink = document.querySelector('nav a[href="login.html"]');
        const nav = document.querySelector('nav');
        
        // Remove existing badge if any
        const existingBadge = document.getElementById('user-badge');
        if (existingBadge) existingBadge.remove();

        if (user && loginLink) {
            // --- LOGGED IN STATE ---
            
            // 1. Change "Login" to "Logout"
            loginLink.textContent = 'Logout';
            loginLink.href = '#';
            loginLink.onclick = (e) => {
                e.preventDefault();
                if(confirm(`Sign out from ${user.email}?`)) {
                    this.logout();
                }
            };

            // 2. Show Role Badge
            const role = localStorage.getItem('ijmr_user_role') || 'User';
            const badge = document.createElement('span');
            badge.id = 'user-badge';
            badge.innerHTML = `<i class="fas fa-user-circle"></i> ${role}`;
            badge.style.cssText = `
                color: var(--primary); 
                font-size: 0.8rem; 
                border: 1px solid var(--primary); 
                padding: 4px 10px; 
                border-radius: 20px; 
                margin-left: 10px; 
                display: inline-flex; 
                align-items: center; 
                gap: 5px;
            `;
            // Insert badge before the logout link (or append to nav)
            nav.insertBefore(badge, loginLink);

        } else if (loginLink) {
            // --- LOGGED OUT STATE ---
            loginLink.textContent = 'Login';
            loginLink.href = 'login.html';
            loginLink.onclick = null; // Remove logout handler
        }
    }
}

// Initialize and Export
const Auth = new AuthService();
// Attach to window so HTML can access it easily
window.Auth = Auth;